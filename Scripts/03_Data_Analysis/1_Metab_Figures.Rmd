---
title: "Metabolism figures using QAQCd metab model outputs"
author: "Dexter Howard"
date: "9/16/2022"
output: html_document
---

##Load packages and make labels used throughout 

```{r}
library(tidyverse)
library(zoo) #for rolling mean
library(ggpubr) #for stat compare mean
library(patchwork)
library(gridExtra)
library(stringr) #wrap x axis label text
library(cowplot) #for plot_grid
library(FSA) #dunn test
library(car) #levene test

metab_label <- c(expression(paste("GPP and R (mg ",O[2], " L"^-1, " day"^-1,")"))) 
metab_label2 <- c(expression(paste("GPP, R, and NEP (mg ",O[2], " L"^-1, " day"^-1,")"))) 
nep_label <- c(expression(paste("NEP (mg ",O[2], " L"^-1, " day"^-1,")"))) 
gpp_label <- c(expression(paste("GPP (mg ",O[2], " L"^-1, " day"^-1,")")))
r_label <- c(expression(paste("R (mg ",O[2], " L"^-1, " day"^-1,")"))) 


```


##Read in and tidy up data 

```{r}
metaboutput <- read.csv("../../Data/Model_Output/MetabOutput_QAQC_15_22.csv")

metaboutput1 <- metaboutput %>% 
  select(solarDay, GPP_QAQC, R_QAQC, NEM_QAQC) %>%
  mutate(R_QAQC = -R_QAQC,          #set R rates to negative
         solarDay = ymd(solarDay))


#bring in operational seasons definition 
seasons_ts_operational <- read.csv("../../Data/Generated_Data/Seasons_operational_Ice.csv")
seasons_ts_operational$Date <- as.Date(seasons_ts_operational$Date)

metab_seasons_operational <- left_join(seasons_ts_operational, metaboutput1, by = c("Date" = "solarDay"))


#read in operational winter and physical summer 
seasons_ts_winterOper_summerPhys <- read.csv("../../Data/Generated_Data/Seasons_Ice_operWinter_physSummer.csv")
seasons_ts_winterOper_summerPhys$Date <- as.Date(seasons_ts_winterOper_summerPhys$Date)

metab_seasons_winterOper_summerPhys <- left_join(seasons_ts_winterOper_summerPhys, metaboutput1, by = c("Date" = "solarDay")) 


#bring in physical winter seasons definition 
seasons_ts_phys <- read.csv("../../Data/Generated_Data/Seasons_Ice_physical.csv")
seasons_ts_phys$Date <- as.Date(seasons_ts_phys$Date)

metab_seasons_phys <- left_join(seasons_ts_phys, metaboutput1, by = c("Date" = "solarDay"))

#bring in solar seasons definition 
seasons_ts_solar <- read.csv("../../Data/Generated_Data/Seasons_solar_Ice.csv")
seasons_ts_solar$Date <- as.Date(seasons_ts_solar$Date)

metab_seasons_solar <- left_join(seasons_ts_solar, metaboutput1, by = c("Date" = "solarDay"))


```


## Fig S4 Testing affect of winter on annual metab on seasons classficiations
for both operational seasons, operation winter and physical summer, physical summer and winter seasons, and solar seasons 

```{r}
### current seasons fig

all_seasons_data_opWint_physSum <- metab_seasons_winterOper_summerPhys %>% 
  group_by(corrected_Year) %>% 
  dplyr::summarise(annual_GPP_Allseasons = median(GPP_QAQC, na.rm = T),
                   annual_R_Allseasons = median(R_QAQC, na.rm = T),
                   annual_NEP_Allseasons = median(NEM_QAQC, na.rm = T)
                   )

nowinter_data_opWint_physSum <- metab_seasons_winterOper_summerPhys %>% 
  filter(Season != "Winter") %>% 
  group_by(corrected_Year) %>% 
  dplyr::summarise(annual_GPP_nowinter = median(GPP_QAQC, na.rm = T),
                   annual_R_nowinter = median(R_QAQC, na.rm = T),
                   annual_NEP_nowinter = median(NEM_QAQC, na.rm = T)
                   )


data_opWint_physSum <- left_join(all_seasons_data_opWint_physSum, nowinter_data_opWint_physSum, by = "corrected_Year")


 x <- data_opWint_physSum %>% 
  filter(corrected_Year %in% c(2016,2018,2019,2021)) %>% 
  select(corrected_Year, annual_NEP_nowinter, annual_NEP_Allseasons) %>% 
  pivot_longer(-1) %>% 
  mutate(name = ifelse(name == "annual_NEP_Allseasons", "All Seasons", "No Winter")) %>% 
  ggplot(mapping = aes(x= name, y = value))+
  geom_boxplot()+
  geom_point(aes(color = as.factor(corrected_Year)), size = 4)+
  labs(x = element_blank(), y = nep_label,
       color = "Year")+
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
  ylim(-0.42, 0.1)+
   stat_compare_means(method = "t.test", paired = T, label.y = 0.08, label.x = 1.3, size = 6)+ #t test 
  theme_bw()+
  theme(legend.position = "none")+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color="black"), axis.title.x = element_text(size=16), axis.title.y = element_text(size=16),
        legend.title = element_text(size=16),  plot.title = element_text(size=20),  axis.text = element_text(size=16,color="black"),  legend.text = element_text(size=16,color="black"))+
  ggtitle("2) operational winter \n physical summer")



### operational winter and summer season fig
all_seasons_data_operational <- metab_seasons_operational %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_Allseasons = median(GPP_QAQC, na.rm = T),
                   annual_R_Allseasons = median(R_QAQC, na.rm = T),
                   annual_NEP_Allseasons = median(NEM_QAQC, na.rm = T)
                   )

nowinter_data_operational <- metab_seasons_operational %>% 
  filter(Season != "Winter") %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_nowinter = median(GPP_QAQC, na.rm = T),
                   annual_R_nowinter = median(R_QAQC, na.rm = T),
                   annual_NEP_nowinter = median(NEM_QAQC, na.rm = T)
                   )

data_operational <- left_join(all_seasons_data_operational, nowinter_data_operational, by = "cor_Year") %>% rename("corrected_Year" = "cor_Year")

w <- data_operational %>% 
  filter(corrected_Year %in% c(2016,2018,2019,2021)) %>% 
  select(corrected_Year, annual_NEP_nowinter, annual_NEP_Allseasons) %>% 
  pivot_longer(-1) %>% 
  mutate(name = ifelse(name == "annual_NEP_Allseasons", "All Seasons", "No Winter")) %>% 
  ggplot(mapping = aes(x= name, y = value))+
  geom_boxplot()+
  geom_point(aes(color = as.factor(corrected_Year)), size = 4)+
  labs(x = element_blank(), y = nep_label,
       color = "Year")+
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
  ylim(-0.42, 0.1)+
   stat_compare_means(method = "t.test", paired = T, label.y = 0.08, label.x = 1.3, size = 6)+ #t test 
  theme_bw()+
  theme(legend.position = "none")+
       theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color="black"), axis.title.x = element_text(size=16), axis.title.y = element_text(size=16),
        legend.title = element_text(size=16),  plot.title = element_text(size=20),  axis.text = element_text(size=16,color="black"),  legend.text = element_text(size=16,color="black"))+
  ggtitle("1) operational winter \n operational summer")



### Phys winter season fig
all_seasons_data_phys <- metab_seasons_phys %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_Allseasons = median(GPP_QAQC, na.rm = T),
                   annual_R_Allseasons = median(R_QAQC, na.rm = T),
                   annual_NEP_Allseasons = median(NEM_QAQC, na.rm = T)
                   )

nowinter_data_phys <- metab_seasons_phys %>% 
  filter(Season != "Winter") %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_nowinter = median(GPP_QAQC, na.rm = T),
                   annual_R_nowinter = median(R_QAQC, na.rm = T),
                   annual_NEP_nowinter = median(NEM_QAQC, na.rm = T)
                   )

data_phys <- left_join(all_seasons_data_phys, nowinter_data_phys, by = "cor_Year")

y<- data_phys %>% 
  filter(cor_Year %in% c(2016,2018,2019,2021)) %>% 
  select(cor_Year, annual_NEP_nowinter, annual_NEP_Allseasons) %>% 
  pivot_longer(-1) %>% 
  mutate(name = ifelse(name == "annual_NEP_Allseasons", "All Seasons", "No Winter")) %>% 
  ggplot(mapping = aes(x= name, y = value))+
  geom_boxplot()+
  geom_point(aes(color = as.factor(cor_Year)), size = 4)+
  labs(x = element_blank(), y = nep_label,
       color = "Year")+
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
  ylim(-0.42, 0.1)+
   stat_compare_means(method = "t.test", paired = T, label.y = 0.08, label.x = 1.3, size = 6)+ #t test 
  theme_bw()+
  theme(legend.position = "none")+
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color="black"), axis.title.x = element_text(size=16), axis.title.y = element_text(size=16),
        legend.title = element_text(size=16),  plot.title = element_text(size=20),  axis.text = element_text(size=16,color="black"),  legend.text = element_text(size=16,color="black"))+
  ggtitle("3) physical winter \n physical summer")

 
### solar winter season fig
all_seasons_data_solar <- metab_seasons_solar %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_Allseasons = median(GPP_QAQC, na.rm = T),
                   annual_R_Allseasons = median(R_QAQC, na.rm = T),
                   annual_NEP_Allseasons = median(NEM_QAQC, na.rm = T)
                   )

nowinter_data_solar <- metab_seasons_solar %>% 
  filter(Season != "Winter") %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_nowinter = median(GPP_QAQC, na.rm = T),
                   annual_R_nowinter = median(R_QAQC, na.rm = T),
                   annual_NEP_nowinter = median(NEM_QAQC, na.rm = T)
                   )

data_solar <- left_join(all_seasons_data_solar, nowinter_data_solar, by = "cor_Year")

 z<- data_solar %>% 
  filter(cor_Year %in% c(2016,2018,2019,2021)) %>% 
  select(cor_Year, annual_NEP_nowinter, annual_NEP_Allseasons) %>% 
  pivot_longer(-1) %>% 
  mutate(name = ifelse(name == "annual_NEP_Allseasons", "All Seasons", "No Winter")) %>% 
  ggplot(mapping = aes(x= name, y = value))+
  geom_boxplot()+
  geom_point(aes(color = as.factor(cor_Year)), size = 4)+
  labs(x = element_blank(), y = nep_label,
       color = "Year")+
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
  ylim(-0.42, 0.1)+
   stat_compare_means(method = "t.test", paired = T, label.y = 0.08, label.x = 1.3, size = 6)+ #t test 
  theme_bw()+
  theme(legend.position = "right")+
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color="black"), axis.title.x = element_text(size=16), axis.title.y = element_text(size=16),
        legend.title = element_text(size=16),  plot.title = element_text(size=20),  axis.text = element_text(size=16,color="black"),  legend.text = element_text(size=16,color="black"))+
  ggtitle("4) Solar")


Fig_S4 <- w | x | y | z

ggsave(filename = "../../Figures/Fig_S4.jpg",
       Fig_S4, device = "jpg", width = 400, height = 250, units = "mm")

```



## Fig 2c; excluding vs including winter 

```{r}
### set up data 

fig2c_all_seasons_data_operational <- metab_seasons_operational %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_Allseasons = median(GPP_QAQC, na.rm = T),
                   annual_R_Allseasons = median(R_QAQC, na.rm = T),
                   annual_NEP_Allseasons = median(NEM_QAQC, na.rm = T)
                   )

fig2c_nowinter_data_operational <- metab_seasons_operational %>% 
  filter(Season != "Winter") %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_nowinter = median(GPP_QAQC, na.rm = T),
                   annual_R_nowinter = median(R_QAQC, na.rm = T),
                   annual_NEP_nowinter = median(NEM_QAQC, na.rm = T)
                   )

fig2c_justwinter_data_operational <- metab_seasons_operational %>% 
  filter(Season == "Winter") %>% 
  group_by(cor_Year) %>% 
  dplyr::summarise(annual_GPP_justwinter = median(GPP_QAQC, na.rm = T),
                   annual_R_justwinter = median(R_QAQC, na.rm = T),
                   annual_NEP_justwinter = median(NEM_QAQC, na.rm = T)
                   )

fig2c_data_operational <- left_join(fig2c_all_seasons_data_operational, fig2c_nowinter_data_operational, by = "cor_Year") 
fig2c_data_operational <- left_join(fig2c_data_operational, fig2c_justwinter_data_operational, by = "cor_Year") %>% 
  rename("corrected_Year" = "cor_Year")


#run t test 
fig2c_data_ttest <- fig2c_data_operational %>% 
    filter(corrected_Year %in% c(2016,2018,2019,2020,2021)) 

t.test(fig2c_data_ttest$annual_NEP_nowinter, fig2c_data_ttest$annual_NEP_Allseasons, paired = T)


### adding just winter to the figure 
levels_fig2c <- c("All Seasons", "No Winter", "Winter Only")
 
fig2c_winterVSnowinter_vsjustwinter <- fig2c_data_operational %>% 
  filter(corrected_Year %in% c(2016,2018,2019,2020,2021)) %>% 
  select(corrected_Year, annual_NEP_nowinter, annual_NEP_Allseasons, annual_NEP_justwinter) %>% 
  pivot_longer(-1) %>% 
    mutate(name = ifelse(name == "annual_NEP_Allseasons", "All Seasons", name),
           name = ifelse(name == "annual_NEP_nowinter", "No Winter", name),
           name = ifelse(name == "annual_NEP_justwinter", "Winter Only", name)) %>% 
  ggplot(mapping = aes(x= factor(name, level = levels_fig2c), y = value))+
  geom_boxplot()+
  geom_jitter(aes(color = as.factor(corrected_Year)), size = 4, position=position_jitter(0))+
    stat_compare_means(method = "kruskal.test", paired = T, label.y = -0.35, label.x = 1.3, size = 6)+
  labs(x = element_blank(), y = nep_label,
       color = element_blank())+
  scale_x_discrete(labels = label_wrap_gen(3))+
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
  ylim(-0.35, 0.1)+
  theme_bw()+
  ggtitle("c")+
  theme(legend.position =  c(0.5, 0.94), legend.direction = "horizontal", 
        legend.background =  element_rect(color = "black", linetype = "solid"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.line = element_line(color="black"))+
  theme(axis.title.x = element_text(size=18),  axis.title.y = element_text(size=18),  legend.title = element_text(size=13),
        plot.title = element_text(size=24),   axis.text = element_text(size=18,color="black"),
        legend.text = element_text(size=13,color="black"))


fig2c_winterVSnowinter_vsjustwinter



 

```



## Fig 2a,b; Full TS for GPP and R and NEP

```{r}
# calc to add 7 day NEP rolling mean
metab_seasons <- metab_seasons_operational %>%
  rename("corrected_Year" = "cor_Year") %>% 
  mutate(NEP_7day_rollmean = rollmean(NEM_QAQC, 7,
                                       fill = NA,
                                       na.rm = T,
                                       align = "center"))

# make full TS of GPP and R
full_ts <- ggplot(data = metab_seasons, aes(x = Date, y = GPP_QAQC))+
  geom_point(shape = 21, color="black", fill ="seagreen3",size=4, alpha = 0.5)+ 
  geom_hline(yintercept = 0, linetype=2, size = 1.5) +
  geom_point(aes(x=Date,y=(R_QAQC)),shape = 21, color = "black", fill ="brown",size=4, alpha = 0.5)+ 
  scale_x_date(breaks = seq(ymd("2016-01-01"), ymd("2022-03-01"), by="12 months"),date_labels="%Y")+
  labs(y=metab_label, x=NULL)+ 
  theme_bw()+
  ggtitle("a")+
  ylim(-19, 12)+
  theme(axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        plot.title = element_text(size=24),
        axis.text.y = element_text(size=18, color="black",margin = margin(l=10,r=5, unit = "pt")),
        axis.text.x = element_text(size=18, color="black",margin = margin(b=10,t=5, unit = "pt")))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm") #,
        # plot.background = element_blank()
        )

full_ts


NEP_full_ts <- metab_seasons %>% 
  ggplot(aes(x = Date, y = NEM_QAQC))+
  geom_point(shape = 21, color="black", fill ="gray61",size=4, alpha = 0.5)+
  scale_x_date(breaks = seq(ymd("2016-01-01"), ymd("2022-03-01"), by="12 months"),date_labels="%Y")+
  geom_line(aes(x = Date, y = NEP_7day_rollmean), size = 1, color = "black")+
  theme_classic()+
  geom_hline(yintercept = 0, size = 1.25, color = "black", linetype = "longdash")+
  ylim(-15, 5)+
  labs(x = element_blank(), y = nep_label)+
  theme_bw()+
  ggtitle("b")+
  theme(axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        plot.title = element_text(size=24),
        axis.text.y = element_text(size=18, color="black",margin = margin(l=10,r=5, unit = "pt")),
        axis.text.x = element_text(size=18, color="black",margin = margin(b=10,t=5, unit = "pt")))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm") )

NEP_full_ts



```


## Fig 2 - full TS and NEP summary by year 

```{r}
#left panel
GPP_R_overNEP <- (full_ts / NEP_full_ts) 

#add right panel 
fig2_withNEPpannel <- cowplot::plot_grid(GPP_R_overNEP , fig2c_winterVSnowinter_vsjustwinter, rel_widths = c(6,4))

#save figure
ggsave(filename = "../../Figures/Fig2.jpg",
       fig2_withNEPpannel, device = "jpg", width = 350, height = 200, units = "mm")

```


## Metab stats for full time series and table 1

```{r}

##add in metab seasons long here
metab_seasons_long <- metab_seasons %>% 
  pivot_longer(-c(1:5)) %>% 
  filter(name != "NEP_7day_rollmean")

metab_seasons <- metab_seasons %>% 
  filter(Date >= ymd("2015-11-11"),
         Date <= ymd("2022-02-28")) 

#### % of daily fits 
## number of NAs
#sum(is.na(metab_seasons$NEM_QAQC))
## % of NAs
#(sum(is.na(metab_seasons$NEM_QAQC))) / nrow(metab_seasons)
## % of days with fits
( nrow(metab_seasons) - (sum(is.na(metab_seasons$NEM_QAQC))) )   / nrow(metab_seasons)

#### number of days NEP is negative 
#sum(!is.na(metab_seasons$NEM_QAQC))
#sum(metab_seasons$NEM_QAQC < 0, na.rm = T) 
sum(metab_seasons$NEM_QAQC < 0, na.rm = T) / sum(!is.na(metab_seasons$NEM_QAQC))




#### Full timeseries metab CVs
R_cv <- sd(metab_seasons$R_QAQC, na.rm = T) / mean(metab_seasons$R_QAQC, na.rm = T)
R_cv
#range(metab_seasons$R_QAQC, na.rm = T)
GPP_cv <- sd(metab_seasons$GPP_QAQC, na.rm = T) / mean(metab_seasons$GPP_QAQC, na.rm = T)
GPP_cv
#range(metab_seasons$GPP_QAQC, na.rm = T)
NEP_cv <- sd(metab_seasons$NEM_QAQC, na.rm = T) / mean(metab_seasons$NEM_QAQC, na.rm = T)
NEP_cv
#range(metab_seasons$NEM_QAQC, na.rm = T)

## F tests for variance 
var.test(metab_seasons$R_QAQC, metab_seasons$GPP_QAQC)
var.test(metab_seasons$R_QAQC, metab_seasons$NEM_QAQC)
var.test(metab_seasons$NEM_QAQC, metab_seasons$GPP_QAQC)

levene_gpp_r <- metab_seasons_long %>% 
  filter(name %in% c("R_QAQC", "GPP_QAQC"))
leveneTest(value ~ name, levene_gpp_r)

levene_gpp_nep <- metab_seasons_long %>% 
  filter(name %in% c("NEM_QAQC", "GPP_QAQC"))
leveneTest(value ~ name, levene_gpp_nep)

levene_nep_r <- metab_seasons_long %>% 
  filter(name %in% c("R_QAQC", "NEM_QAQC"))
leveneTest(value ~ name, levene_nep_r)


#wilcox test for full ts 
wilcox.test(metab_seasons$R_QAQC, metab_seasons$GPP_QAQC)
wilcox.test(metab_seasons$R_QAQC, metab_seasons$NEM_QAQC)
wilcox.test(metab_seasons$NEM_QAQC, metab_seasons$GPP_QAQC)



#### summer and winter NEP range thats reported in abstract
#Summer NEP range 
metab_seasons_long %>% 
  filter(Season == "Summer")  %>% 
  group_by(name) %>% 
  summarise(range = range(value, na.rm = T)) %>% 
  filter(name == "NEM_QAQC")

#Winter NEP range 
metab_seasons_long %>% 
  filter(Season == "Winter")  %>% 
  group_by(name) %>% 
  summarise(range = range(value, na.rm = T)) %>% 
  filter(name == "NEM_QAQC")
  


################## Table 1 - Full timeseries stats 

## Full timeseries metab summary stats table 
fullTSgroup <- metab_seasons_long %>% 
  filter(!is.na(name)) %>% 
  group_by(name) %>% 
  summarise(min = min(value, na.rm = T),
            quantile25 = quantile(value, probs = c(.25), na.rm = T),
            mean = mean(value, na.rm = T),
            median = median(value, na.rm = T),
            quantile75 = quantile(value, probs = c(.75), na.rm = T),
            max = max(value, na.rm = T),
            sd = sd(value, na.rm = T)
            ) %>% 
  mutate(NEW_name = paste(name, "AllData", sep = "_")) %>% 
  select(name, median, sd, min, max) 

fullTSgroup

## Seasons summary stats for full TS 
seasons_summaryStats_clean <- metab_seasons_long %>% 
  filter(!is.na(name)) %>% 
  group_by(name, Season) %>% 
  summarise(min = min(value, na.rm = T),
            quantile25 = quantile(value, probs = c(.25), na.rm = T),
            mean = mean(value, na.rm = T),
            median = median(value, na.rm = T),
            quantile75 = quantile(value, probs = c(.75), na.rm = T),
            max = max(value, na.rm = T),
            sd = sd(value, na.rm = T)
            ) %>% 
  mutate(median_sd = paste(round(median, 2), round(sd, 2), sep = " +- "),
         range =   paste(round(min, 3), round(max, 3), sep = " - ")  ) %>% 
  select(name, Season, range) %>% 
  pivot_wider(names_from = Season, values_from = range) %>% 
  select(name, Spring, Summer, Fall, Winter)
  

seasons_summaryStats_clean

## Ice on vs ice off summary stats 
iceonoff_summaryStats_clean <- metab_seasons_long %>% 
  filter(!is.na(name),
         Season == "Winter") %>% 
  mutate(Ice_on_off = ifelse(icevector == 1, "Ice Cover", "No Ice Cover")) %>%  
  group_by(name, Ice_on_off) %>% 
  summarise(min = min(value, na.rm = T),
            quantile25 = quantile(value, probs = c(.25), na.rm = T),
            mean = mean(value, na.rm = T),
            median = median(value, na.rm = T),
            quantile75 = quantile(value, probs = c(.75), na.rm = T),
            max = max(value, na.rm = T),
            sd = sd(value, na.rm = T)
            ) %>% 
  mutate(median_sd = paste(round(median, 2), round(sd, 2), sep = " +- "),
         range =   paste(round(min, 3), round(max, 3), sep = " - ")  ) %>% 
  select(name, Ice_on_off, range) %>% 
  pivot_wider(names_from = Ice_on_off, values_from = range)  
  
iceonoff_summaryStats_clean

```

##### Revisions test 
several comments
```{r}

#### rates arround turnover 
#make data frame of dates of turnover (with fake year) to add to facets
turnover_dates <- data.frame(dates = c("2030-10-14", "2030-10-25", "2030-10-22", "2030-11-02", "2030-11-02", "2030-11-03"), Year = c(2016,2017,2018,2019,2020,2021))

metab_seasons |> 
  filter(Date >= paste(year(Date), 10, 1, sep = "-"),
         Date <= paste(year(Date), 12, 1, sep = "-")) |> 
  mutate(Year = year(Date)) |> 
  mutate(fakeDate = ymd(paste(2030, month(Date), day(Date), sep = "-"))) |> 
  ggplot(aes(x = fakeDate, y = NEM_QAQC))+
  geom_point()+
  facet_wrap(~Year, ncol = 1)+
  geom_vline(data = turnover_dates,
             mapping = aes(xintercept = as.Date(dates)), linetype = 'dashed')+
  theme_bw()

metab_seasons |> 
  filter(Date >= paste(year(Date), 10, 1, sep = "-"),
         Date <= paste(year(Date), 12, 1, sep = "-")) |> 
  mutate(Year = year(Date)) |> 
  mutate(fakeDate = ymd(paste(2030, month(Date), day(Date), sep = "-"))) |> 
  ggplot(aes(x = fakeDate, y = GPP_QAQC))+
  geom_point()+
  facet_wrap(~Year, ncol = 1)+
    geom_vline(data = turnover_dates,
             mapping = aes(xintercept = as.Date(dates)), linetype = 'dashed')+
  theme_bw()

metab_seasons |> 
  filter(Date >= paste(year(Date), 10, 1, sep = "-"),
         Date <= paste(year(Date), 12, 1, sep = "-")) |> 
  mutate(Year = year(Date)) |> 
  filter(Year > 2015) |> 
  mutate(fakeDate = ymd(paste(2030, month(Date), day(Date), sep = "-"))) |> 
  ggplot(aes(x = fakeDate, y = R_QAQC))+
  geom_point()+
  facet_wrap(~Year, ncol = 1)+
    geom_vline(data = turnover_dates,
             mapping = aes(xintercept = as.Date(dates)), linetype = 'dashed')+
  theme_bw()+
  labs(x = element_blank(), y = r_label)


### line 325-326 are years and seasons balanced talbe 
metab_seasons |> 
  group_by(corrected_Year, Season ) |> 
  summarise(total =   paste(sum(!is.na(NEM_QAQC)), "/"  , (sum(!is.na(NEM_QAQC)) + sum(is.na(NEM_QAQC))), sep = "")
            ) |> 
  pivot_wider(names_from = Season, values_from = total)
  
# metab_seasons |>
#   group_by(corrected_Year) |>
#   summarise(total =   paste(sum(!is.na(NEM_QAQC)), "/"  , (sum(!is.na(NEM_QAQC)) + sum(is.na(NEM_QAQC))), sep = ""))


#### under ice Kd 
secchi <- read.csv("../../Data/EDI2023/FCR_secchi_2022.csv")

#iceKDplot <- 
  
  secchi |> 
  filter(Reservoir == "FCR", Site == 50,
         DateTime > ymd("2022-01-01")) |> 
  mutate(Kd = 1.7/Secchi_m) |> 
  ggplot(aes(x = as.Date(DateTime), y = Kd))+
  geom_point()+
  geom_vline(xintercept = ymd("2022-01-31"))+
    labs(x = element_blank())

  iceKDplot
# ggplotly(iceKDplot)
  

```

pdf distributions for expanding table 1

```{r}

metab_seasons_long <- metab_seasons_long |> 
  mutate(name = ifelse(name == 'GPP_QAQC', "GPP", name),
         name = ifelse(name == 'R_QAQC', "R", name),
         name = ifelse(name == 'NEM_QAQC', "NEP", name))

pdf_all <- metab_seasons_long |> 
  # mutate(Reservoir = "FCR") |> 
  ggplot()+
  geom_density(aes(value),fill = "lightgray",  alpha = 0.4)+ #fill = "lightgray"
  facet_wrap(~name, scales = "free")+
  theme_bw() + theme(text = element_text(size=14), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ #, legend.position = "none"
  labs( x = element_blank())   #+ scale_fill_manual(values = c("lightgray"))


pdf_seasons <- metab_seasons_long |> 
  # filter(value < 9,
  #        value > -10) |> 
  ggplot()+
  geom_density(aes(value, fill= as.factor(Season)), alpha = 0.2)+
  facet_wrap(~name, scales = "free")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size=14), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
   scale_fill_manual(values = c( "darkorange3", "darkturquoise", "green4", "slategray"))+
    #coord_flip()+
  labs(fill = "Season", x = element_blank())

# pdf_seasons_nowinter <- metab_seasons_long |> 
#   filter(Season != "Winter") |> 
#   ggplot()+
#   geom_density(aes(value, fill= as.factor(Season)), alpha = 0.2)+
#   facet_wrap(~name, scales = "free_x")+
#   theme_bw()+ theme(legend.position = "top", text = element_text(size=14), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
#    scale_fill_manual(values = c( "darkorange3", "darkturquoise", "green4"))+
#     #coord_flip()+
#   labs(fill = "Season", x = element_blank())

# pdf_winter <- metab_seasons_long |> 
#   filter(Season == "Winter") |> 
#   mutate(Ice = ifelse(icevector == 1, "Ice", "No Ice")) |> 
#   ggplot()+
#   geom_density(aes(value, fill = factor(Ice, levels = c("No Ice", "Ice"))), alpha = 0.8)+ #, alpha = 0.4
#   facet_wrap(~name, scales = "free_x")+
#   theme_bw()+ theme(legend.position = "top", text = element_text(size=14), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
#   scale_fill_manual(values = c("skyblue2", "#FAF9F6"))+
#   #scale_fill_brewer(values = c( "Ice" = "#FAF9F6", "No Ice" = "skyblue2"), direction = -1)+
#   labs(fill = "Ice-cover", x = metab_label2)

pdf_winter_gpp <- metab_seasons_long |> 
  filter(Season == "Winter",
         name == "GPP") |> 
  mutate(Ice = ifelse(icevector == 1, "Ice", "No Ice")) |> 
  ggplot()+
  geom_density(aes(value, fill = factor(Ice, levels = c("No Ice", "Ice"))), alpha = 0.8)+ #, alpha = 0.4
  facet_wrap(~name, scales = "free_x")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size=14), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_fill_manual(values = c("skyblue2", "#FAF9F6"))+
  labs(fill = "Ice-cover", x = gpp_label)

pdf_winter_r <- metab_seasons_long |> 
  filter(Season == "Winter",
         name == "R") |> 
  mutate(Ice = ifelse(icevector == 1, "Ice", "No Ice")) |> 
  ggplot()+
  geom_density(aes(value, fill = factor(Ice, levels = c("No Ice", "Ice"))), alpha = 0.8)+ #, alpha = 0.4
  facet_wrap(~name, scales = "free_x")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size=14), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_fill_manual(values = c("skyblue2", "#FAF9F6"))+
  labs(fill = "Ice-cover", x = r_label, y = element_blank())


pdf_winter_nep <- metab_seasons_long |> 
  filter(Season == "Winter",
         name == "NEP") |> 
  mutate(Ice = ifelse(icevector == 1, "Ice", "No Ice")) |> 
  ggplot()+
  geom_density(aes(value, fill = factor(Ice, levels = c("No Ice", "Ice"))), alpha = 0.8)+ #, alpha = 0.4
  facet_wrap(~name, scales = "free_x")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size=14), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_fill_manual(values = c("skyblue2", "#FAF9F6"))+
  xlim(min(metab_seasons$NEM_QAQC, na.rm = T), max(metab_seasons$NEM_QAQC, na.rm = T))+
  labs(fill = "Ice-cover", x = nep_label, y = element_blank())


winter_z <- cowplot::plot_grid(pdf_winter_gpp, pdf_winter_nep, pdf_winter_r, ncol = 3)

z <- cowplot::plot_grid(pdf_all, pdf_seasons, winter_z, labels = c("a", "b", "c"), 
                        ncol = 1, rel_heights = c(1.6, 2.1, 2.1))

ggsave(filename = "../../Figures/newfig_pdf.jpg",
       z, device = "jpg", width = 300, height = 200, units = "mm")


```



## Fig S5, Table S2 and S3
Yearly stats for supplement table and figures

```{r}
################# yearly stats; data for Supplementary table S2; and Supplementary Figure S5 
#get yearly stats for sup table S2
yearly_grouping <- metab_seasons %>% 
  group_by(corrected_Year) %>% 
  filter(corrected_Year %in% c(2016, 2018, 2019, 2020, 2021) ) %>% 
  summarise(R_median_sd = paste(round(median(R_QAQC, na.rm = T), 2), round(sd(R_QAQC, na.rm = T), 2), sep = " +- "),
            R_range =   paste(round(min(R_QAQC, na.rm = T), 2), round(max(R_QAQC, na.rm = T), 2), sep = " - "),  
            R_CV = round(sd(R_QAQC, na.rm = T) / mean(R_QAQC, na.rm = T), 2),
            GPP_median_sd = paste(round(median(GPP_QAQC, na.rm = T), 2), round(sd(GPP_QAQC, na.rm = T), 2), sep = " +- "),
            GPP_range =   paste(round(min(GPP_QAQC, na.rm = T), 2), round(max(GPP_QAQC, na.rm = T), 2), sep = " - "), 
            GPP_CV = round(sd(GPP_QAQC, na.rm = T) / mean(GPP_QAQC, na.rm = T), 2),
            NEP_median_sd = paste(round(median(NEM_QAQC, na.rm = T), 2), round(sd(NEM_QAQC, na.rm = T), 2), sep = " +- "),
            NEP_range =   paste(round(min(NEM_QAQC, na.rm = T), 2), round(max(NEM_QAQC, na.rm = T), 2), sep = " - "),
            NEP_CV = round(sd(NEM_QAQC, na.rm = T) / mean(NEM_QAQC, na.rm = T), 2)
            ) 

#Table S2
yearly_grouping

#Fig S5
gpp_acrossyears_kruskal <- metab_seasons %>% 
  filter(corrected_Year %in% c(2016, 2018, 2019, 2020, 2021)) %>% 
  ggplot(aes(x = as.factor(corrected_Year), y = GPP_QAQC))+ 
  geom_boxplot(alpha = 0.5, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.1))+
  labs(x = element_blank(),  y = gpp_label)+
  ylim(0,17)+
  stat_compare_means(method = "kruskal.test", 
                     label.y = 14, label.x = 2, size = 6 )+ # , aes(label = paste0("p = ", after_stat(p.format)))
  theme_bw(base_size = 14)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color="black"), axis.title.x = element_text(size=16), axis.title.y = element_text(size=16),
        legend.title = element_text(size=16),  plot.title = element_text(size=20),  axis.text = element_text(size=16,color="black"),  legend.text = element_text(size=16,color="black"))
 

r_acrossyears_kruskal <- metab_seasons %>% 
  filter(corrected_Year %in% c(2016, 2018, 2019, 2020, 2021)) %>% 
  ggplot(aes(x = as.factor(corrected_Year), y = R_QAQC))+ 
  geom_boxplot(alpha = 0.5, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.1))+
  labs(x = element_blank(),  y = r_label)+
  ylim(-17,0)+
  scale_y_reverse()+
  stat_compare_means(method = "kruskal.test", 
                     label.y = 14, label.x = 2, size = 6 )+ # , aes(label = paste0("p = ", after_stat(p.format)))
  theme_bw(base_size = 16)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color="black"), axis.title.x = element_text(size=16), axis.title.y = element_text(size=16),
        legend.title = element_text(size=16),  plot.title = element_text(size=20),  axis.text = element_text(size=16,color="black"),  legend.text = element_text(size=16,color="black"))

nep_acrossyears_kruskal <- metab_seasons %>% 
  filter(corrected_Year %in% c(2016, 2018, 2019, 2020, 2021)) %>% 
  ggplot(aes(x = as.factor(corrected_Year), y = NEM_QAQC))+ 
  geom_boxplot(alpha = 0.5, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.1))+
  labs(x = element_blank(),  y = nep_label)+
  stat_compare_means(method = "kruskal.test", 
                     label.y = -13, label.x = 2, size = 6 )+ # , aes(label = paste0("p = ", after_stat(p.format)))
  theme_bw(base_size = 14)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color="black"), axis.title.x = element_text(size=16), axis.title.y = element_text(size=16),
        legend.title = element_text(size=16),  plot.title = element_text(size=20),  axis.text = element_text(size=16,color="black"),  legend.text = element_text(size=16,color="black"))


nep_acrossyears_kruskal_data <- metab_seasons %>% 
  filter(corrected_Year %in% c(2016, 2018, 2019, 2020, 2021))

kruskal.test(NEM_QAQC ~ corrected_Year, data = nep_acrossyears_kruskal_data)

dunn <- FSA::dunnTest(NEM_QAQC ~ corrected_Year, data = nep_acrossyears_kruskal_data)
# dunn$res

SupFig_S5 <- gpp_acrossyears_kruskal / r_acrossyears_kruskal / nep_acrossyears_kruskal

ggsave(filename = "../../Figures/Fig_S5_metab_acrossyears.jpg",
       SupFig_S5, device = "jpg", width = 350, height = 200, units = "mm")


######################## summary stats by year and season; Sup Fig 6   
#make table that has summary stats for each season per year 
season_grouping <- metab_seasons %>% 
  group_by(corrected_Year, Season) %>% 
  summarise(R_median_sd = paste(round(median(R_QAQC, na.rm = T), 2), round(sd(R_QAQC, na.rm = T), 2), sep = " +- "),
            R_range =   paste(round(min(R_QAQC, na.rm = T), 2), round(max(R_QAQC, na.rm = T), 2), sep = " - "),  
            R_CV = round(sd(R_QAQC, na.rm = T) / mean(R_QAQC, na.rm = T), 2),
            GPP_median_sd = paste(round(median(GPP_QAQC, na.rm = T), 2), round(sd(GPP_QAQC, na.rm = T), 2), sep = " +- "),
            GPP_range =   paste(round(min(GPP_QAQC, na.rm = T), 2), round(max(GPP_QAQC, na.rm = T), 2), sep = " - "), 
            GPP_CV = round(sd(GPP_QAQC, na.rm = T) / mean(GPP_QAQC, na.rm = T), 2),
            NEP_median_sd = paste(round(median(NEM_QAQC, na.rm = T), 2), round(sd(NEM_QAQC, na.rm = T), 2), sep = " +- "),
            NEP_range =   paste(round(min(NEM_QAQC, na.rm = T), 2), round(max(NEM_QAQC, na.rm = T), 2), sep = " - "),
            NEP_CV = round(sd(NEM_QAQC, na.rm = T) / mean(NEM_QAQC, na.rm = T), 2)
            ) 

#Table S3
season_grouping


```

## Inter vs. intra annual variation, Section 3.1

```{r}

##Interannual 

inter_var <- metab_seasons_long %>% 
  group_by(name, corrected_Year) %>% 
    filter(corrected_Year %in% c(2016, 2018, 2019, 2020, 2021) ) %>% 
  summarise(median = median(value, na.rm=T))%>% 
  filter(name != "NEP_7day_rollmean") %>% 
  group_by(name) %>% 
  summarise(Inter_variation = round( (max(median) - min(median)), digits = 2  ))


##Intra 

intra_var <- metab_seasons_long %>% 
  filter(!is.na(name)) %>% 
  group_by(name, Season) %>% 
  summarise(median = median(value, na.rm = T)
            ) %>% 
  select(name, Season, median) %>% 
  filter(name != "NEP_7day_rollmean") %>% 
  group_by(name) %>% 
  summarise(Intra_variation = round( (max(median) - min(median)), digits = 2  ))


## Difference 
left_join(intra_var, inter_var, by = "name") %>% 
  mutate(Intra_div_Inter = Intra_variation/Inter_variation) %>% 
    mutate(Inter_div_Intra = Inter_variation/Intra_variation)


```




## Fig 3 - Winter GPP and R w/ ice cover plots

```{r}
#make blank rectangles that get overwritten in each plot
rect1 <- data.frame(xmin = 0, xmax = 0, ymin = 0, ymax = 0)
rect2 <- data.frame(xmin = 0, xmax = 0, ymin = 0, ymax = 0)
rect3 <- data.frame(xmin = 0, xmax = 0, ymin = 0, ymax = 0)

#2022
metab2022 <- metab_seasons %>% 
  filter(Date <= ymd("2022-02-22"),
         Date >= ymd("2021-12-20")) %>% 
  ggplot(aes(x = Date, y = GPP_QAQC))+
  ylim(-3,2)+
  geom_vline(xintercept = ymd("2022-01-11"))+   
  geom_vline(xintercept = ymd("2022-01-13"))+
  geom_vline(xintercept = ymd("2022-01-16"))+   
  geom_vline(xintercept = ymd("2022-02-09"))+ 
  geom_rect(data= rect1, aes(xmin=as.Date("2022-01-11"), xmax=as.Date("2022-01-13"), ymin= -Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE) +
  geom_rect(data= rect2, aes(xmin= as.Date("2022-01-16"), xmax= as.Date("2022-02-09"), ymin= -Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE) +
  labs(y=NULL, x=NULL)+
  geom_hline(yintercept = 0, linetype=2, size = 1.5) +
  geom_point(shape = 21, color="black", fill ="seagreen3",size=4)+ # green 3,  lightgreen, seagreen3, springgreen3
  geom_point(aes(x=Date,y=(R_QAQC)),shape = 21, color = "black", fill ="brown",size=4)+ #gray30 for darker outline

  geom_line(aes(x = Date, y = NEP_7day_rollmean), size = 2, color = "black", alpha = 0.8)+ #7 day rolling mean
  scale_x_date(breaks = seq(min(ymd("2021-12-20")), max(ymd("2022-02-22")), by = "21 days") , date_labels = "%d %b")+
 theme_bw(base_size = 22)+
   theme(panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm"),
        plot.background = element_blank(),
        panel.background = element_rect(fill = "skyblue2"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  ggtitle("2022 Winter")

metab2022

#2021
metab2021 <- metab_seasons %>% 
  filter(Date <= ymd("2021-02-22"),
         Date >= ymd("2020-12-20")) %>% 
  ggplot()+
  ylim(-3,2)+
  geom_vline(xintercept = ymd("2020-12-27"))+   
  geom_vline(xintercept = ymd("2020-12-29"))+
  geom_vline(xintercept = ymd("2021-01-10"))+   
  geom_vline(xintercept = ymd("2021-02-08"))+ 
  geom_vline(xintercept = ymd("2021-02-11"))+   
  geom_vline(xintercept = ymd("2021-02-22"))+ 
  geom_rect(data= rect1, aes(xmin=as.Date("2020-12-27"), xmax=as.Date("2020-12-29"), ymin=-Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE) +
  geom_rect(data= rect2, aes(xmin= as.Date("2021-01-10 00:00:00"), xmax= as.Date("2021-02-08 00:00:00"), ymin=-Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE) +
  geom_rect(data= rect3, aes(xmin= as.Date("2021-02-11 00:00:00"), xmax= as.Date("2021-02-22 00:00:00"), ymin=-Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE) +
  labs(y=NULL, x=NULL)+   
  geom_hline(yintercept = 0, linetype=2, size = 1.5) +
  geom_point(aes(x = Date, y = GPP_QAQC), shape = 21, color="black", fill ="seagreen3",size=4)+
  geom_point(aes(x=Date,y=(R_QAQC)),shape = 21, color = "black", fill ="brown",size=4)+
  geom_line(aes(x = Date, y = NEP_7day_rollmean), size = 2, color = "black", alpha = 0.8)+ #7 day rolling mean
  scale_x_date(breaks = seq(min(ymd("2020-12-20")), max(ymd("2021-02-22")), by = "21 days") , date_labels = "%d %b")+
 theme_bw(base_size = 22)+
   theme(panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm"),
        plot.background = element_blank(),
        panel.background = element_rect(fill = "skyblue2"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  ggtitle("2021 Winter")

metab2021
  
#2020
metab2020 <- metab_seasons %>% 
  filter(Date <= ymd("2020-02-22"),
         Date >= ymd("2019-12-20")) %>% 
  ggplot(aes(x = Date, y = GPP_QAQC))+
  ylim(-3,2)+
  labs(y=metab_label2, x=NULL)+
  geom_hline(yintercept = 0, linetype=2, size = 1.5) +
  geom_point(shape = 21, color="black", fill ="seagreen3",size=4)+ 
  geom_point(aes(x=Date,y=(R_QAQC)),shape = 21, color = "black", fill ="brown",size=4)+
  geom_line(aes(x = Date, y = NEP_7day_rollmean), size = 2, color = "black", alpha = 0.8)+ #7 day rolling mean
  scale_x_date(breaks = seq(min(ymd("2019-12-20")), max(ymd("2020-02-22")), by = "21 days") , date_labels = "%d %b")+
 theme_bw(base_size = 22)+
   theme(panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm"),
        plot.background = element_blank(),
        panel.background = element_rect(fill = "skyblue2"),
        panel.grid.major = element_blank(),
              axis.title.y = element_text(hjust = -0.5),
        panel.grid.minor = element_blank()) +
  ggtitle("2020 Winter")

metab2020

#2019
metab2019 <- metab_seasons %>% 
  filter(Date <= ymd("2019-02-22"),
         Date >= ymd("2018-12-20")) %>% 
  ggplot(aes(x = Date, y = GPP_QAQC))+
  labs(y=NULL, x=NULL)+
  ylim(-3,2)+
  geom_vline(xintercept = as.Date("2019-01-21"))+   #ice on 1/21/19 and off 1/24/2019
  geom_vline(xintercept = as.Date("2019-01-24"))+
  geom_vline(xintercept = as.Date("2019-01-27"))+   #ice on 1/27/19 and off 2/2/2019
  geom_vline(xintercept = as.Date("2019-02-02"))+ 
  geom_rect(data= rect1, aes(xmin=as.Date("2019-01-21"), xmax=as.Date("2019-01-24"), ymin=-Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE) +
  geom_rect(data= rect2, aes(xmin=as.Date("2019-01-27"), xmax=as.Date("2019-02-02"), ymin=-Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE) +
  geom_hline(yintercept = 0, linetype=2, size = 1.5) +
  geom_point(shape = 21, color="black", fill ="seagreen3",size=4)+ 
  geom_point(aes(x=Date,y=(R_QAQC*-1)),shape = 21, color = "black", fill ="brown",size=4)+
  geom_line(aes(x = Date, y = NEP_7day_rollmean), size = 2, color = "black", alpha = 0.8)+ #7 day rolling mean
  scale_x_date(breaks = seq(min(ymd("2018-12-20")), max(ymd("2019-02-22")), by = "21 days") , date_labels = "%d %b")+
 theme_bw(base_size = 22)+
   theme(panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm"),
        plot.background = element_blank(),
        panel.background = element_rect(fill = "skyblue2"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  ggtitle("2019 Winter")

metab2019

#2018
metab2018 <- metab_seasons %>% 
  filter(Date <= ymd("2018-02-22"),
         Date >= ymd("2017-12-20")) %>% 
  ggplot(aes(x = Date, y = GPP_QAQC))+
  ylim(-3,2)+
  geom_vline(xintercept = as.Date("2017-12-28"))+   
  geom_vline(xintercept = as.Date("2018-01-08"))+
  geom_rect(data= rect1, aes(xmin=as.Date("2017-12-28"), xmax=as.Date("2018-01-08"), ymin=-Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE)+
  labs(y=NULL, x=NULL)+   
  geom_hline(yintercept = 0, linetype=2, size = 1.5) +
  geom_point(shape = 21, color="black", fill ="seagreen3",size=4)+ 
  geom_point(aes(x=Date,y=(R_QAQC)),shape = 21, color = "black", fill ="brown",size=4)+
  geom_line(aes(x = Date, y = NEP_7day_rollmean), size = 2, color = "black", alpha = 0.8)+ #7 day rolling mean
  scale_x_date(breaks = seq(min(ymd("2017-12-20")), max(ymd("2018-02-22")), by = "21 days") , date_labels = "%d %b")+
  theme_bw(base_size = 22)+
   theme(panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm"),
        plot.background = element_blank(),
        panel.background = element_rect(fill = "skyblue2"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  ggtitle("2018 Winter")

metab2018

#2016
metab2016 <- metab_seasons %>% 
  filter(Date <= ymd("2016-02-22"),
         Date >= ymd("2015-12-20")) %>% 
  ggplot(aes(x = Date, y = GPP_QAQC))+
  labs(y=NULL, x=NULL)+ 
  ylim(-3,2)+
  geom_vline(xintercept = as.Date("2016-01-21"))+
  geom_vline(xintercept = as.Date("2016-02-21"))+
  geom_rect(data= rect1, aes(xmin=as.Date("2016-01-21"), xmax=as.Date("2016-02-21"), ymin=-Inf, ymax=Inf), fill="#FAF9F6", alpha=1, inherit.aes = FALSE)+
  geom_hline(yintercept = 0, linetype=2, size = 1.5) +
  geom_point(shape = 21, color="black", fill ="seagreen3",size=4)+ 
  geom_point(aes(x=Date,y=(R_QAQC)),shape = 21, color = "black", fill ="brown",size=4)+
  geom_line(aes(x = Date, y = NEP_7day_rollmean), size = 2, color = "black", alpha = 0.8)+ #7 day rolling mean
  scale_x_date(breaks = seq(min(ymd("2015-12-20")), max(ymd("2016-02-22")), by = "21 days") , date_labels = "%d %b")+
  theme_bw(base_size = 22)+
   theme(panel.border = element_rect(color = "black", size =1),
        #axis.line = element_line(color="black"),
        axis.ticks.length = unit(.2, "cm"),
        plot.background = element_blank(),
        panel.background = element_rect(fill = "skyblue2"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        ) +
  ggtitle("2016 Winter")

metab2016



#Bind together each plot and make final figure 

fig3 <- (metab2016 + metab2018 + metab2019) / (metab2020 + metab2021 + metab2022)

ggsave(filename = "../../Figures/Fig3.jpg",
       fig3, device = "jpg", width = 350, height = 200, units = "mm")



```


## Fig 1b; Ice cover plot 

```{r}
ice <- read.csv("../../Data/EDI2023/Ice_Data_2013_2022.csv")
ice$Date <- as.Date(ice$Date)

icetotaldays <- data.frame(Year = c(2016, 2017, 2018, 2019, 2020, 2021, 2022), 
                           Days_iceCover = c(32, 3, 12, 9, 0, 35, 28))
icetotaldays$Year <- as.character(icetotaldays$Year)


#2016
ice2016 <- data.frame(Date = seq(as.Date("2015-12-01"), as.Date("2016-03-31"), by="day"))
ice2016dates <- c(seq(as.Date("2016-01-21"), as.Date("2016-02-21"), by="day"))
ice2016$icevector <- ifelse(ice2016$Date %in% ice2016dates, 1, 0)
ice2016$julianDOY <- format(ice2016$Date, "%j")
ice2016$Days_since_1Dec <- c(0:(nrow(ice2016)-1))

#2017
ice2017 <- data.frame(Date = seq(as.Date("2016-12-01"), as.Date("2017-03-31"), by="day"))
ice2017dates <- c(as.Date("2016-12-20") , as.Date("2017-01-08"), as.Date("2017-01-13"))
ice2017$icevector <- ifelse(ice2017$Date %in% ice2017dates, 1, 0)
ice2017$julianDOY <- format(ice2017$Date, "%j")
ice2017$Days_since_1Dec <- c(0:(nrow(ice2017)-1))

#2018
ice2018 <- data.frame(Date = seq(as.Date("2017-12-01"), as.Date("2018-03-31"), by="day"))
ice2018dates <- c(seq(as.Date("2017-12-28"), as.Date("2018-01-08"), by="day"))
ice2018$icevector <- ifelse(ice2018$Date %in% ice2018dates, 1, 0)
ice2018$julianDOY <- format(ice2018$Date, "%j")
ice2018$Days_since_1Dec <- c(0:(nrow(ice2018)-1))

#2019
ice2019 <- data.frame(Date = seq(as.Date("2018-12-01"), as.Date("2019-03-31"), by="day"))
ice2019dates <- c(seq(as.Date("2019-01-21"), as.Date("2019-01-23"), by="day"), seq(as.Date("2019-01-27"), as.Date("2019-02-01"), by="day"))
ice2019$icevector <- ifelse(ice2019$Date %in% ice2019dates, 1, 0)
ice2019$julianDOY <- format(ice2019$Date, "%j")
ice2019$Days_since_1Dec <- c(0:(nrow(ice2019)-1))


#2020
ice2020 <- data.frame(Date = seq(as.Date("2019-12-01"), as.Date("2020-03-31"), by="day"))
ice2020$icevector <- 0
ice2020$julianDOY <- format(ice2020$Date, "%j")
ice2020$Days_since_1Dec <- c(0:(nrow(ice2020)-1))


#2021
ice2021 <- data.frame(Date = seq(as.Date("2020-12-01"), as.Date("2021-03-31"), by="day"))
ice2021dates <- c(seq(as.Date("2020-12-27"), as.Date("2020-12-29"), by="day"), 
                  seq(as.Date("2021-01-10"), as.Date("2021-02-08"), by="day"), 
                  seq(as.Date("2021-02-11"), as.Date("2021-02-22"), by="day"))
ice2021$icevector <- ifelse(ice2021$Date %in% ice2021dates, 1, 0)
ice2021$julianDOY <- format(ice2021$Date, "%j")
ice2021$Days_since_1Dec <- c(0:(nrow(ice2021)-1))

#2022
ice2022 <- data.frame(Date = seq(as.Date("2021-12-01"), as.Date("2022-03-31"), by="day"))
ice2022dates <- c( seq(as.Date("2022-01-11"), as.Date("2022-01-13"), by="day"),
                   seq(as.Date("2022-01-16"), as.Date("2022-02-09"), by="day"))
ice2022$icevector <- ifelse(ice2022$Date %in% ice2022dates, 1, 0)
ice2022$julianDOY <- format(ice2022$Date, "%j")
ice2022$Days_since_1Dec <- c(0:(nrow(ice2022)-1))

#making the plot
binded_icedata <- rbind(ice2016, ice2017, ice2018, ice2019, ice2020, ice2021, ice2022)

binded_icedata <- binded_icedata %>% 
  mutate(Year = as.numeric(format(as.Date(Date), "%Y")),
         Month = as.numeric(format(as.Date(Date), "%m"))) %>% 
  mutate(corrected_years = ifelse(Year == 2015 & Month == 12, 2016, Year),
         corrected_years = ifelse(Year == 2016 & Month == 12, 2017, corrected_years),
         corrected_years = ifelse(Year == 2017 & Month == 12, 2018, corrected_years),
         corrected_years = ifelse(Year == 2018 & Month == 12, 2019, corrected_years),
         corrected_years = ifelse(Year == 2019 & Month == 12, 2020, corrected_years),
         corrected_years = ifelse(Year == 2020 & Month == 12, 2021, corrected_years),
         corrected_years = ifelse(Year == 2021 & Month == 12, 2022, corrected_years)) %>% 
  mutate(corrected_years = as.character(corrected_years))

binded_icedata_remove_zeros <- binded_icedata %>% 
  filter(Month %in% c(1,2,3,12)) %>% 
  mutate(icevector_yn = ifelse(icevector == 1, "On", "Off"))


icecover_dotplots_B <-  binded_icedata_remove_zeros %>% 
  mutate(icevector_yn_A = ifelse(icevector_yn == "Off", "No Ice Cover", "Ice Cover")) %>% 
  dplyr::mutate(Day = day(Date),
                # Month_Date = paste(Month, Day, sep = "-"),
                fakeYear = ifelse(Month == 12, 2023, 2024), 
                fakeDate = paste(fakeYear, Month, Day, sep = "-"),
                fakeDate = as.Date(fakeDate)) %>% 
  filter(fakeDate >= ymd("2023-12-20"),
         fakeDate <= ymd("2024-02-22")) %>% 
  ggplot(mapping = aes(x = fakeDate, y = corrected_years))+
  geom_tile(aes(fill = factor(icevector_yn_A, levels = c("No Ice Cover", "Ice Cover"))))+ #, alpha = 0.2
  scale_x_date(breaks = seq(min(ymd("2023-12-20")), max(ymd("2024-02-22")), by = "28 days") , date_labels = "%d %b", expand = c(0,0))+
  scale_y_discrete(expand=c(0,0))+ #remove space on either end of y axis
  labs(fill = element_blank(),
       x = element_blank(), y = "Winter Season")+
  geom_hline(yintercept=7.5, linewidth = 1)+
  geom_hline(yintercept=6.5, linewidth = 1)+
  geom_hline(yintercept=5.5, linewidth = 1)+
  geom_hline(yintercept=4.5, linewidth = 1)+
  geom_hline(yintercept=3.5, linewidth = 1)+
  geom_hline(yintercept=2.5, linewidth = 1)+
  geom_hline(yintercept=1.5, linewidth = 1)+
  geom_hline(yintercept=0.5, linewidth = 1)+
  theme(legend.position="top",
        legend.background =  element_rect(color = "black", linetype = "solid", fill = "gray83"))+
  theme(panel.border=element_blank(),
        axis.line = element_line(color="black"),
        # plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  theme(axis.title.x = element_text(size=32),
        axis.title.y = element_text(size=32),
        legend.title = element_text(size=32),
        axis.text = element_text(size=32,color="black"),
        legend.text = element_text(size=32,color="black"))+ #these size were 18 before 
   scale_fill_manual(values=c( "skyblue2", "#FAF9F6"))


icecover_dotplots_B

 ggsave(filename = "../../Figures/Fig1b_icecover.jpg",
        icecover_dotplots_B, device = "jpg", width = 10.6, height = 20, units = "in")

```


## Fig 5a,b, Fig S6; Winter NEP boxplots 

```{r}
#filter down to winter data
winterNEP <- metab_seasons %>% 
  filter(Date >= "2015-12-01",
         Date <= "2022-02-28") %>%  #removing times from incomplete winters 
  filter(Season == "Winter") %>% 
  filter(corrected_Year != "2017")


### Fig S6 facet by year 

#NEP; also fig 4a
wintercomp_byyear_NEP <- winterNEP %>% 
  mutate(Ice_on_off = ifelse(icevector == 1, "Ice", "No Ice")) %>% 
  ggplot(aes(x = as.factor(Ice_on_off), y = NEM_QAQC, fill = Ice_on_off))+ # , fill = Ice_on_off
  geom_boxplot(alpha = 1, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.1))+
  facet_wrap(~corrected_Year, scales = "fixed", nrow = 1)+
  labs(x = element_blank(),  y = nep_label)+
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
  # stat_compare_means(method = "wilcox.test", aes(label = paste0("p = ", after_stat(p.format))), 
  #                    label.y = -6, label.x = 1, size = 6 )+
   stat_compare_means(method = "wilcox.test", label.y = -7.8, label.x = 1, size = 6, aes(label = sprintf("p = %5.2f", as.numeric(..p.format..))))+ #round to 2 digits
  theme_bw(base_size = 18)+
  theme(legend.position = "top",
        axis.title.y = element_text(size=14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  guides(fill = FALSE) + #remove ice on off from legend since its already on x axis
  scale_fill_manual(values = c( "#FAF9F6", "skyblue2"))

#GPP
wintercomp_byyear_GPP <- winterNEP %>% 
  mutate(Ice_on_off = ifelse(icevector == 1, "Ice", "No Ice")) %>% 
  ggplot(aes(x = as.factor(Ice_on_off), y = GPP_QAQC, fill = Ice_on_off))+ # , fill = Ice_on_off
  geom_boxplot(alpha = 1, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.1))+
  facet_wrap(~corrected_Year, scales = "fixed", nrow = 1)+
  labs(x = element_blank(),  y = gpp_label)+
  stat_compare_means(method = "wilcox.test", aes(label = paste0("p = ", after_stat(p.format))), 
                     label.y = 1.7, label.x = 1, size = 6  )+
  theme_bw(base_size = 18)+
  theme(legend.position = "none",
        axis.title.y = element_text(size=14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_fill_manual(values = c( "#FAF9F6", "skyblue2"))

#R
wintercomp_byyear_R <- winterNEP %>% 
  mutate(Ice_on_off = ifelse(icevector == 1, "Ice", "No Ice")) %>% 
  ggplot(aes(x = as.factor(Ice_on_off), y = R_QAQC, fill = Ice_on_off))+ # , fill = Ice_on_off
  geom_boxplot(alpha = 1, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.1))+
  facet_wrap(~corrected_Year, scales = "fixed", nrow = 1)+
  labs(x = element_blank(),  y = r_label)+
  stat_compare_means(method = "wilcox.test", aes(label = paste0("p = ", after_stat(p.format))), 
                     label.y = 3, label.x = 1, size = 6  )+
  theme_bw(base_size = 18)+
  scale_y_reverse()+
  theme(legend.position = "none",
        axis.title.y = element_text(size=14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  scale_fill_manual(values = c( "#FAF9F6", "skyblue2"))


wintercomps_byyears <- wintercomp_byyear_NEP / wintercomp_byyear_R / wintercomp_byyear_GPP

ggsave(filename = "../../Figures/Fig_S6_WinterComp_byyears.jpg",
        wintercomps_byyears, device = "jpg", width = 350, height = 200, units = "mm")

### Fig 4b Winter NEP average to year 
wintercomp_acrossyears <- winterNEP %>% 
  group_by(corrected_Year, icevector) %>% 
  summarise(NEP = mean(NEM_QAQC, na.rm = T)) %>% 
  mutate(Ice_on_off = ifelse(icevector == 1, "Ice", "No Ice")) %>% 
  ggplot(aes(x = as.factor(Ice_on_off), y = NEP, fill = Ice_on_off))+   # , fill = Ice_on_off
  geom_boxplot(position = position_dodge(preserve = "single"), alpha = 1, outlier.shape = NA)+   #, outlier.alpha = 0
  geom_jitter(aes(shape = as.character(corrected_Year)), position=position_jitter(0.1), size = 4, fill = "white")+
  scale_shape_manual(values = c(0,1,2,5,6,7)) +
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
  stat_compare_means(method = "wilcox.test", paired = F, label.y = -1.5, label.x = 1, size = 6, aes(label = sprintf("Wilcoxon, p = %5.2f", as.numeric(..p.format..))))+ #round to 2 digits
  ylim(-1.5, 0.5)+
  labs(fill = element_blank(),
       shape = "Year",
       x = element_blank(),
       y = nep_label)+
  theme_bw(base_size = 18)+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  guides(fill = FALSE) + #remove ice on off from legend since its already on x axis
  scale_fill_manual(values = c( "#FAF9F6", "skyblue2"))
  
wintercomp_acrossyears


 fig5 <- wintercomp_byyear_NEP + wintercomp_acrossyears + plot_layout(widths = c(7,3)) + plot_annotation(tag_levels = 'a')


ggsave(filename = "../../Figures/Fig5.jpg",
       fig5, device = "jpg", width = 350, height = 150, units = "mm")
  

```


## Fig 4 Seasons boxplots 

```{r}
## set up data and levels for plotting 
level_order <- c("Winter", "Spring", "Summer", "Fall")

boxdata <- metab_seasons %>% 
  filter(Date > ymd("2015-12-19"),
         Date < ymd("2022-02-23")) %>% #removing extra time from fall 2015 and spring 2022 that don't have full seasons 
  mutate(corrected_Year = as.character(corrected_Year)) %>% 
  filter(corrected_Year %in% c("2016", "2018", "2019", "2020", "2021"))

boxdata_grouped <-  boxdata %>% 
  group_by(corrected_Year, Season) %>% 
  summarise(R = mean(R_QAQC, na.rm = T),
            GPP = mean(GPP_QAQC, na.rm = T),
            NEP = mean(NEM_QAQC, na.rm = T))

# Seasonal R across years 
kruskalR_seasons <- kruskal.test(R ~ Season, data = boxdata_grouped)
kruskalR_seasons
dunnR_seasons <- FSA::dunnTest(R ~ Season, data = boxdata_grouped)
dunnR_seasons_letters <- dunnR_seasons$res
dunnR_seasons_letters_list <- rcompanion::cldList(comparison = dunnR_seasons_letters$Comparison, p.value = dunnR_seasons_letters$P.adj, threshold = 0.05)

Rseasonscomp_acrossyears <-
left_join(boxdata_grouped, dunnR_seasons_letters_list, by = c("Season" = "Group")) %>%
  ggplot(aes(x = factor(Season, level = level_order), y = R))+   # , fill = Ice_on_off
  geom_boxplot(aes(fill = Season), position = position_dodge(preserve = "single"), alpha = 0.5, outlier.shape = NA)+ #, outlier.alpha = 0
  geom_jitter(aes(shape = as.character(corrected_Year)) , position=position_jitter(0.3), size = 3, fill = "black")+
  scale_shape_manual(values = c(0,1,2,5,6,7)) +
    stat_compare_means(method = "kruskal.test", label.y = -0.2, label.x = 1.3, size = 6, aes(label = sprintf("Kruskal-Wallis, p = %5.2f", as.numeric(..p.format..))))+ #round to 2 digits
  geom_text(aes(x = Season, label = Letter), y = 2.85, size = 6)+
  scale_y_reverse(limits = c(0.2, -3))+
  labs(fill = element_blank(),
       shape = "Year",
       x = element_blank(),
       y = r_label)+
  theme_bw(base_size = 18)+
  theme(legend.position = "none",
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  guides(fill = FALSE) +
 scale_fill_manual(values = c( "darkorange3", "darkturquoise", "green4", "slategray"))


# Seasonal GPP across years 
kruskalGPP_seasons <- kruskal.test(GPP ~ Season, data = boxdata_grouped)
kruskalGPP_seasons
dunnGPP_seasons <- FSA::dunnTest(GPP ~ Season, data = boxdata_grouped)
dunnGPP_seasons_letters <- dunnGPP_seasons$res
dunnGPP_seasons_letters_list <- rcompanion::cldList(comparison = dunnGPP_seasons_letters$Comparison, p.value = dunnGPP_seasons_letters$P.adj, threshold = 0.05)

GPPseasonscomp_acrossyears <-
  left_join(boxdata_grouped, dunnGPP_seasons_letters_list, by = c("Season" = "Group")) %>%
  ggplot(aes(x = factor(Season, level = level_order), y = GPP))+   # , fill = Ice_on_off
  geom_boxplot(aes(fill = Season), position = position_dodge(preserve = "single"), alpha = 0.5, outlier.shape = NA)+
  geom_jitter(aes(shape = as.character(corrected_Year)) , position=position_jitter(0.3), size = 3)+
  scale_shape_manual(values = c(0,1,2,5,6,7)) +
      stat_compare_means(method = "kruskal.test", label.y = -0.2, label.x = 1.3, size = 6, aes(label = sprintf("Kruskal-Wallis, p = %5.2f", as.numeric(..p.format..))))+ #round to 2 digits
  geom_text(aes(x = Season, label = Letter), y = 2.85, size = 6)+
  ylim(-0.2,3)+
  labs(fill = element_blank(),
       shape = "Year",
       x = element_blank(),
       y = gpp_label)+
  theme_bw(base_size = 18)+
  theme(legend.position = "none",
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  guides(fill = FALSE) +
 scale_fill_manual(values = c( "darkorange3", "darkturquoise", "green4", "slategray"))
 


# Seasonal NEP across years 
kruskalNEP_seasons <- kruskal.test(NEP ~ Season, data = boxdata_grouped)
kruskalNEP_seasons

NEPseasonscomp_acrossyears <- boxdata_grouped %>%
  ggplot(aes(x = factor(Season, level = level_order), y = NEP))+   # , fill = Ice_on_off
  geom_boxplot(aes(fill = Season), position = position_dodge(preserve = "single"), alpha = 0.5, outlier.shape = NA)+ #, outlier.alpha = 0
  geom_jitter(aes(shape = as.character(corrected_Year)) , position=position_jitter(0.3), size = 3, fill = "black")+
  scale_shape_manual(values = c(0,1,2,5,6,7)) +
  geom_hline(yintercept = 0, linetype=2, size = 0.75) +
      stat_compare_means(method = "kruskal.test", label.y = -2.5, label.x = 1.3, size = 6, aes(label = sprintf("Kruskal-Wallis, p = %5.2f", as.numeric(..p.format..))))+ #round to 2 digits
  ylim(-2.5, 0.5)+
  labs(fill = element_blank(),
       shape = "Year",
       x = element_blank(),
       y = nep_label)+
  theme_bw(base_size = 18)+
  theme(legend.position = "right",
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  guides(fill = FALSE) +
 scale_fill_manual(values = c( "darkorange3", "darkturquoise", "green4", "slategray"))


#combine plots
Rseasonscomp_acrossyears + GPPseasonscomp_acrossyears + NEPseasonscomp_acrossyears

fig4 <- Rseasonscomp_acrossyears + GPPseasonscomp_acrossyears + NEPseasonscomp_acrossyears + plot_annotation(tag_levels = 'a')

ggsave(filename = "../../Figures/Fig4.jpg",
       fig4, device = "jpg", width = 350, height = 150, units = "mm")


```





